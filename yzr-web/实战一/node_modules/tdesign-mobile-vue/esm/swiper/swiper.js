/**
 * tdesign v0.12.1
 * (c) 2022 TDesign Group
 * @license MIT
 */

import _slicedToArray from '@babel/runtime/helpers/slicedToArray';
import { defineComponent, getCurrentInstance, ref, computed, reactive, onMounted, nextTick, watch, provide, resolveComponent, openBlock, createElementBlock, normalizeStyle, normalizeClass, createElementVNode, renderSlot, Fragment, createVNode, createCommentVNode, renderList, toDisplayString, createBlock } from 'vue';
import { ChevronLeftIcon, ChevronRightIcon } from 'tdesign-icons-vue-next';
import { useSwipe } from '@vueuse/core';
import SwiperProps from './props.js';
import config from '../config.js';
import '../shared/index.js';
import TNodeComponent from '../shared/render-tnode.js';
import { useDefault } from '../shared/useDefault/index.js';
import { renderTNode } from '../shared/render.js';
import _defineProperty from '@babel/runtime/helpers/defineProperty';
import '../shared/functions.js';
import '../shared/util.js';
import '../shared/component.js';
import '../shared/constants.js';
import '../shared/useToggle/index.js';
import '../shared/useCountDown/index.js';
import '@babel/runtime/helpers/asyncToGenerator';
import '@babel/runtime/regenerator';
import '../shared/useCountDown/utils.js';
import '../shared/useEmitEvent/index.js';
import 'lodash/camelCase';
import '../shared/useChildSlots/index.js';
import '@babel/runtime/helpers/toConsumableArray';
import '../shared/useVModel/index.js';
import '../shared/useTouch/index.js';
import '../shared/useScrollParent/index.js';
import '../shared/useExpose/index.js';
import '@babel/runtime/helpers/typeof';

var prefix = config.prefix;
var name = "".concat(prefix, "-swiper");
var setOffset = function setOffset(element, offset) {
  var direction = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : "X";
  element.style.transform = "translate".concat(direction, "(").concat(offset, "px)");
};
var script = defineComponent({
  name: name,
  components: {
    ChevronLeftIcon: ChevronLeftIcon,
    ChevronRightIcon: ChevronRightIcon,
    TNode: TNodeComponent
  },
  props: SwiperProps,
  emits: ["change", "update:current", "update:modelValue"],
  setup: function setup(props, context) {
    var _useDefault = useDefault(props, context.emit, "current", "change"),
      _useDefault2 = _slicedToArray(_useDefault, 2),
      swiperValue = _useDefault2[0],
      setSwiperValue = _useDefault2[1];
    var self = getCurrentInstance();
    var swiperContainer = ref(null);
    var computedNavigation = computed(function () {
      return renderTNode(self, "navigation");
    });
    var height = props.height || 180;
    var state = reactive({
      showNavigation: true,
      activeIndex: 0,
      itemLength: 0,
      itemWidth: 0,
      isControl: false,
      btnDisabled: false,
      children: []
    });
    var paginationList = computed(function () {
      return new Array(state.itemLength).fill(1);
    });
    var showPageNum = computed(function () {
      var activeIndex = state.activeIndex,
        itemLength = state.itemLength;
      if (activeIndex > itemLength - 1) return itemLength;
      if (activeIndex < 0) return 1;
      return activeIndex + 1;
    });
    var childCount = computed(function () {
      return state.children.length;
    });
    var getContainer = function getContainer() {
      var _self$proxy;
      return self === null || self === void 0 ? void 0 : (_self$proxy = self.proxy) === null || _self$proxy === void 0 ? void 0 : _self$proxy.$el.querySelector(".".concat(name, "__container"));
    };
    var initSwiper = function initSwiper() {
      var _swiperContainer$chil, _swiperContainer$quer;
      var _swiperContainer = getContainer();
      _swiperContainer.querySelectorAll(".copy-item").forEach(function (ele) {
        _swiperContainer.removeChild(ele);
      });
      var items = _swiperContainer.querySelectorAll(".".concat(name, "-item"));
      state.itemLength = ((_swiperContainer$chil = _swiperContainer.children) === null || _swiperContainer$chil === void 0 ? void 0 : _swiperContainer$chil.length) || 0;
      var itemWidth = ((_swiperContainer$quer = _swiperContainer.querySelector(".".concat(name, "-item"))) === null || _swiperContainer$quer === void 0 ? void 0 : _swiperContainer$quer.getBoundingClientRect().width) || 0;
      state.itemWidth = itemWidth;
      if (items.length <= 0) return false;
      if (computedNavigation.value && "minShowNum" in computedNavigation.value && items.length < computedNavigation.value.minShowNum) {
        state.showNavigation = false;
      }
      if (props !== null && props !== void 0 && props.loop) {
        var first = items[0].cloneNode(true);
        first.classList.add("copy-item");
        var last = items[items.length - 1].cloneNode(true);
        last.classList.add("copy-item");
        _swiperContainer.appendChild(first);
        _swiperContainer.insertBefore(last, items[0]);
      }
      move(0);
      startAutoplay();
      if (typeof props.current === "number") {
        state.isControl = true;
        next(props.current);
      }
    };
    onMounted(function () {
      nextTick(function () {
        console.info("swiper mounted");
        initSwiper();
      });
    });
    watch(function () {
      return state.children.length;
    }, function () {
      nextTick(function () {
        console.info("swiper mounted");
        initSwiper();
      });
    });
    var autoplayTimer = null;
    var actionIsTrust = true;
    var move = function move(targetIndex) {
      var isTrust = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
      var _swiperContainer = getContainer();
      var moveDirection = (props === null || props === void 0 ? void 0 : props.direction) === "horizontal" ? "X" : "Y";
      var moveLength = (props === null || props === void 0 ? void 0 : props.direction) === "vertical" ? height : state.itemWidth;
      actionIsTrust = isTrust;
      _swiperContainer.dataset.isTrust = "".concat(isTrust);
      var toIndex = props !== null && props !== void 0 && props.loop ? targetIndex + 1 : targetIndex;
      _swiperContainer.style.transform = "translate".concat(moveDirection, "(-").concat(moveLength * toIndex, "px)");
    };
    var addAnimation = function addAnimation() {
      var _swiperContainer = getContainer();
      _swiperContainer.style.transition = "transform ".concat(props === null || props === void 0 ? void 0 : props.duration, "ms");
    };
    var removeAnimation = function removeAnimation() {
      var _swiperContainer = getContainer();
      _swiperContainer.style.transition = "none";
    };
    var handleAnimationEnd = function handleAnimationEnd() {
      state.btnDisabled = false;
      removeAnimation();
      if (state.activeIndex >= state.itemLength) {
        state.activeIndex = 0;
        move(0);
      }
      if (state.activeIndex <= -1) {
        state.activeIndex = state.itemLength - 1;
        move(state.itemLength - 1);
      }
      setTimeout(function () {
        actionIsTrust && emitCurrentChange(state.activeIndex);
      }, 0);
    };
    var stopAutoplay = function stopAutoplay() {
      if (!autoplayTimer) return;
      clearInterval(autoplayTimer);
      autoplayTimer = null;
    };
    var startAutoplay = function startAutoplay() {
      if (typeof props.current === "number") return false;
      if (!(props !== null && props !== void 0 && props.autoplay) || autoplayTimer !== null) return false;
      autoplayTimer = setInterval(function () {
        state.activeIndex += 1;
        if (!(props !== null && props !== void 0 && props.loop) && state.activeIndex >= state.children.length - 1) {
          state.activeIndex = 0;
        }
        if (!(props !== null && props !== void 0 && props.loop) && state.activeIndex <= 0) {
          state.activeIndex = state.children.length - 1;
        }
        addAnimation();
        move(state.activeIndex);
      }, props === null || props === void 0 ? void 0 : props.interval);
    };
    var emitCurrentChange = function emitCurrentChange(index) {
      var resultIndex = index;
      if (index >= state.itemLength) resultIndex = 0;
      if (index < 0) resultIndex = state.itemLength - 1;
      setSwiperValue(resultIndex);
    };
    var prev = function prev() {
      var step = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;
      var cannotMovePrev = !(props !== null && props !== void 0 && props.loop) && state.activeIndex === 0;
      if (state.btnDisabled || cannotMovePrev) {
        move(state.activeIndex);
        return false;
      }
      stopAutoplay();
      state.activeIndex -= step;
      addAnimation();
      move(state.activeIndex);
      startAutoplay();
      state.btnDisabled = true;
    };
    var next = function next() {
      var step = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;
      var cannotMoveLast = !(props !== null && props !== void 0 && props.loop) && state.activeIndex === state.itemLength - 1;
      if (state.btnDisabled || cannotMoveLast) {
        move(state.activeIndex);
        return false;
      }
      stopAutoplay();
      state.activeIndex += step;
      addAnimation();
      move(state.activeIndex);
      startAutoplay();
      state.btnDisabled = true;
    };
    var _useSwipe = useSwipe(swiperContainer, {
        passive: false,
        onSwipeStart: function onSwipeStart(e) {
          if (state.btnDisabled) return false;
          stopAutoplay();
        },
        onSwipe: function onSwipe(e) {
          if (state.btnDisabled) return false;
          onTouchMove(e);
        },
        onSwipeEnd: function onSwipeEnd() {
          onTouchEnd();
        }
      }),
      lengthX = _useSwipe.lengthX,
      lengthY = _useSwipe.lengthY;
    var onTouchMove = function onTouchMove(event) {
      event.preventDefault();
      var activeIndex = state.activeIndex,
        itemWidth = state.itemWidth;
      var distanceX = lengthX.value;
      var distanceY = lengthY.value;
      var _container = getContainer();
      removeAnimation();
      var toIndex = props !== null && props !== void 0 && props.loop ? activeIndex + 1 : activeIndex;
      if ((props === null || props === void 0 ? void 0 : props.direction) === "horizontal") {
        setOffset(_container, -(toIndex * itemWidth + distanceX));
      } else {
        var _props$height = props.height,
          height2 = _props$height === void 0 ? 180 : _props$height;
        setOffset(_container, -(toIndex * height2 + distanceY), "Y");
      }
    };
    var onTouchEnd = function onTouchEnd() {
      var distanceX = lengthX.value;
      var distanceY = lengthY.value;
      addAnimation();
      if ((props === null || props === void 0 ? void 0 : props.direction) === "horizontal" && distanceX < -100 || (props === null || props === void 0 ? void 0 : props.direction) === "vertical" && distanceY < -100) {
        prev(1);
      } else if ((props === null || props === void 0 ? void 0 : props.direction) === "horizontal" && distanceX > 100 || (props === null || props === void 0 ? void 0 : props.direction) === "vertical" && distanceY > 100) {
        next(1);
      } else {
        move(state.activeIndex);
      }
      startAutoplay();
    };
    var relation = function relation(child) {
      if (child.proxy) {
        state.children.push(child.proxy);
      }
    };
    provide("parent", {
      props: props,
      relation: relation
    });
    watch(function () {
      return props.current;
    }, function (newPage, oldPage) {
      if (state.isControl) {
        state.activeIndex = newPage || 0;
        addAnimation();
        move(state.activeIndex, false);
      }
    });
    return {
      swiperContainer: swiperContainer,
      name: name,
      computedNavigation: computedNavigation,
      onTouchMove: onTouchMove,
      onTouchEnd: onTouchEnd,
      handleAnimationEnd: handleAnimationEnd,
      state: state,
      paginationList: paginationList,
      showPageNum: showPageNum,
      prev: prev,
      next: next
    };
  }
});

var _hoisted_1 = {
  key: 0
};
var _hoisted_2 = {
  key: 1
};
function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_chevron_left_icon = resolveComponent("chevron-left-icon");
  var _component_chevron_right_icon = resolveComponent("chevron-right-icon");
  var _component_t_node = resolveComponent("t-node");
  return openBlock(), createElementBlock("div", {
    style: normalizeStyle({
      height: "".concat(_ctx.height, "px"),
      overflow: "hidden"
    }),
    class: normalizeClass("".concat(_ctx.name))
  }, [createElementVNode("div", {
    ref: "swiperContainer",
    class: normalizeClass("".concat(_ctx.name, "__container")),
    style: normalizeStyle({
      height: "".concat(_ctx.height, "px"),
      flexDirection: _ctx.direction === "horizontal" ? "row" : "column"
    }),
    onTransitionend: _cache[0] || (_cache[0] = function () {
      return _ctx.handleAnimationEnd && _ctx.handleAnimationEnd.apply(_ctx, arguments);
    })
  }, [renderSlot(_ctx.$slots, "default")], 38), _ctx.navigation && _ctx.state.showNavigation ? (openBlock(), createElementBlock(Fragment, {
    key: 0
  }, [_ctx.direction === "horizontal" && "showSlideBtn" in _ctx.navigation && _ctx.navigation.showSlideBtn ? (openBlock(), createElementBlock("span", _hoisted_1, [createElementVNode("span", {
    class: normalizeClass("".concat(_ctx.name, "__btn btn-prev")),
    onClick: _cache[1] || (_cache[1] = function ($event) {
      return _ctx.prev(1);
    })
  }, [createVNode(_component_chevron_left_icon, {
    size: "20px"
  })], 2), createElementVNode("span", {
    class: normalizeClass("".concat(_ctx.name, "__btn btn-next")),
    onClick: _cache[2] || (_cache[2] = function ($event) {
      return _ctx.next(1);
    })
  }, [createVNode(_component_chevron_right_icon, {
    size: "20px"
  })], 2)])) : createCommentVNode("", true), "type" in _ctx.navigation ? (openBlock(), createElementBlock("span", {
    key: 1,
    class: normalizeClass("".concat(_ctx.name, "__pagination ").concat(_ctx.name, "__pagination-").concat(_ctx.navigation.type || "", " ").concat(_ctx.name, "__pagination-").concat(_ctx.paginationPosition))
  }, [["dots", "dots-bar"].includes(_ctx.navigation.type || "") ? (openBlock(true), createElementBlock(Fragment, {
    key: 0
  }, renderList(_ctx.state.children.length, function (item, index) {
    var _normalizeClass2;
    return openBlock(), createElementBlock("span", {
      key: "page" + index,
      class: normalizeClass((_normalizeClass2 = {}, _defineProperty(_normalizeClass2, "".concat(_ctx.name, "-dot"), true), _defineProperty(_normalizeClass2, "".concat(_ctx.name, "-dot--active"), index === _ctx.state.activeIndex), _normalizeClass2))
    }, null, 2);
  }), 128)) : createCommentVNode("", true), _ctx.navigation.type && _ctx.navigation.type === "fraction" ? (openBlock(), createElementBlock("span", _hoisted_2, toDisplayString(_ctx.showPageNum + "/" + _ctx.state.children.length), 1)) : createCommentVNode("", true)], 2)) : createCommentVNode("", true)], 64)) : _ctx.computedNavigation !== void 0 ? (openBlock(), createBlock(_component_t_node, {
    key: 1,
    content: _ctx.computedNavigation,
    style: {}
  }, null, 8, ["content"])) : createCommentVNode("", true)], 6);
}

script.render = render;

export { script as default };
//# sourceMappingURL=swiper.js.map
