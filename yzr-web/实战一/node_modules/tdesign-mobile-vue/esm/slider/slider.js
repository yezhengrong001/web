/**
 * tdesign v0.12.1
 * (c) 2022 TDesign Group
 * @license MIT
 */

import _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';
import _defineProperty from '@babel/runtime/helpers/defineProperty';
import _typeof from '@babel/runtime/helpers/typeof';
import _slicedToArray from '@babel/runtime/helpers/slicedToArray';
import { defineComponent, ref, toRefs, getCurrentInstance, computed, reactive, resolveComponent, openBlock, createElementBlock, normalizeClass, toDisplayString, createCommentVNode, createElementVNode, normalizeStyle, Fragment, renderList, createVNode } from 'vue';
import config from '../config.js';
import props from './props.js';
import { useVModel } from '../shared/useVModel/index.js';
import '../shared/index.js';
import TNodeComponent from '../shared/render-tnode.js';
import { renderTNode } from '../shared/render.js';
import '../shared/functions.js';
import '../shared/util.js';
import '../shared/component.js';
import '../shared/constants.js';
import '../shared/useToggle/index.js';
import '../shared/useCountDown/index.js';
import '@babel/runtime/helpers/asyncToGenerator';
import '@babel/runtime/regenerator';
import '@vueuse/core';
import '../shared/useCountDown/utils.js';
import '../shared/useDefault/index.js';
import 'lodash/camelCase';
import '../shared/useEmitEvent/index.js';
import '../shared/useChildSlots/index.js';
import '../shared/useTouch/index.js';
import '../shared/useScrollParent/index.js';
import '../shared/useExpose/index.js';

var prefix = config.prefix;
var name = "".concat(prefix, "-slider");
var isArray = Array.isArray;
var script = defineComponent({
  name: name,
  components: {
    TNode: TNodeComponent
  },
  props: props,
  emits: ["drag-start", "drag-end", "update:modelValue", "change"],
  setup: function setup(props2, context) {
    var rootRef = ref(null);
    var barRef = ref(null);
    var defaultValue = props2.defaultValue || props2.min;
    var _toRefs = toRefs(props2),
      value = _toRefs.value,
      modelValue = _toRefs.modelValue,
      max = _toRefs.max,
      min = _toRefs.min;
    var _useVModel = useVModel(value, modelValue, defaultValue, props2.onChange),
      _useVModel2 = _slicedToArray(_useVModel, 2),
      innerValue = _useVModel2[0],
      setInnerValue = _useVModel2[1];
    var internalInstance = getCurrentInstance();
    var labelContent = computed(function () {
      return !props2.range && props2.label && (_typeof(renderTNode(internalInstance, "label")) === "object" ? renderTNode(internalInstance, "label") : "".concat(innerValue.value));
    });
    var isRange = computed(function () {
      return props2.range && isArray(innerValue.value) && innerValue.value.length === 2;
    });
    var dots = computed(function () {
      if (isRange.value) return innerValue.value;
      if (typeof innerValue.value === "number") return [innerValue.value];
      return [];
    });
    var classes = computed(function () {
      var _ref;
      return ["".concat(name, "-wrap"), (_ref = {}, _defineProperty(_ref, "".concat(prefix, "-is-disabled"), props2.disabled), _defineProperty(_ref, "".concat(prefix, "-is-mark"), props2.marks), _defineProperty(_ref, "".concat(prefix, "-is-value"), props2.showExtremeValue), _ref)];
    });
    var handleClass = computed(function () {
      return ["".concat(name, "__handle")];
    });
    var marksData = computed(function () {
      var sorter = function sorter(a, b) {
        return a[0] - b[0];
      };
      if (!props2.range && props2.marks) {
        if (isArray(props2.marks)) {
          return props2.marks.map(function (val) {
            return [val, val];
          }).sort(sorter);
        }
        return Object.entries(props2.marks).map(function (_ref2) {
          var _ref3 = _slicedToArray(_ref2, 2),
            key = _ref3[0],
            value2 = _ref3[1];
          return [parseInt(key, 10), value2];
        }).sort(sorter);
      }
      return [];
    });
    var dragStatus = ref("");
    var touchData = reactive({
      startValue: 0,
      newValue: 0,
      startX: 0,
      deltaX: 0,
      offsetX: 0
    });
    function onTouchStart(event, value2) {
      if (props2.disabled) {
        return;
      }
      event.stopPropagation();
      event.preventDefault();
      touchData.deltaX = 0;
      touchData.offsetX = 0;
      touchData.startX = event.touches[0].clientX;
      touchData.startValue = format(value2);
      dragStatus.value = "start";
    }
    function onTouchMove(event, index) {
      if (props2.disabled) return;
      if (!barRef.value) return;
      event.stopPropagation();
      event.preventDefault();
      if (dragStatus.value === "start") {
        context.emit("drag-start");
      }
      var touch = event.touches[0];
      touchData.deltaX = touch.clientX - touchData.startX;
      touchData.offsetX = Math.abs(touchData.deltaX);
      dragStatus.value = "dragging";
      var rect = barRef.value.getBoundingClientRect();
      var delta = touchData.deltaX;
      var total = rect.width;
      var diff = delta / total * (props2.max - props2.min);
      touchData.newValue = touchData.startValue + diff;
      updateValue(touchData.newValue, index);
    }
    function onTouchEnd(event, index) {
      if (props2.disabled) {
        return;
      }
      event.stopPropagation();
      event.preventDefault();
      if (dragStatus.value === "dragging") {
        updateValue(touchData.newValue, index, true);
        context.emit("drag-end");
      }
      dragStatus.value = "";
    }
    function onClick(event) {
      var _innerValue$value;
      event.stopPropagation();
      if (props2.disabled) return;
      if (!barRef.value) return;
      var rect = barRef.value.getBoundingClientRect();
      var delta = event.clientX - rect.left;
      var total = rect.width;
      var current = +props2.min + delta / total * (props2.max - props2.min);
      var index = 0;
      if (props2.range && innerValue.value) {
        if (Math.abs(current - innerValue.value[0]) > Math.abs(current - innerValue.value[1])) {
          index = 1;
        }
      }
      touchData.startValue = (_innerValue$value = innerValue.value) === null || _innerValue$value === void 0 ? void 0 : _innerValue$value[index];
      updateValue(current, index, true);
    }
    function format(value2) {
      var current = value2;
      if (!props2.range && props2.marks) {
        var _marksData$value;
        if (marksData !== null && marksData !== void 0 && (_marksData$value = marksData.value) !== null && _marksData$value !== void 0 && _marksData$value.length) {
          var _marksData$value$ = _slicedToArray(marksData.value[0], 1),
            min2 = _marksData$value$[0];
          marksData.value.forEach(function (_ref4) {
            var _ref5 = _slicedToArray(_ref4, 1),
              marksDataItemValue = _ref5[0];
            if (Math.abs(marksDataItemValue - value2) < Math.abs(min2 - value2)) {
              min2 = marksDataItemValue;
            }
          });
          current = min2;
        }
      }
      return Math.round(Math.max(props2.min, Math.min(current, props2.max)) / props2.step) * props2.step;
    }
    function updateValue(newValue, index) {
      var end = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
      var formatValue = format(newValue);
      if (props2.range && Array.isArray(innerValue.value)) {
        var tmpValue = _toConsumableArray(innerValue.value);
        tmpValue[index] = formatValue;
        if (end && formatValue !== touchData.startValue) {
          tmpValue.sort(function (a, b) {
            return a - b;
          });
          setInnerValue(tmpValue);
        } else if (formatValue !== touchData.startValue) {
          setInnerValue(tmpValue);
        }
      } else if (formatValue !== touchData.startValue) {
        setInnerValue(formatValue);
      }
    }
    var getPercentage = function getPercentage(value2) {
      return (value2 ? value2 - props2.min : 0) / (props2.max - props2.min) * 100;
    };
    var trackStyle = computed(function () {
      if (props2.range && isArray(innerValue.value)) {
        return {
          left: "".concat(getPercentage(Math.min(innerValue.value[0], innerValue.value[1])), "%"),
          width: "".concat(getPercentage(Math.abs(innerValue.value[1] - innerValue.value[0])), "%")
        };
      }
      if (!isArray(innerValue.value)) {
        return {
          width: "".concat(getPercentage(innerValue.value), "%")
        };
      }
      return {};
    });
    return {
      max: max,
      min: min,
      name: ref(name),
      marksData: marksData,
      rootRef: rootRef,
      barRef: barRef,
      dots: dots,
      value: innerValue,
      labelContent: labelContent,
      classes: classes,
      handleClass: handleClass,
      trackStyle: trackStyle,
      getPercentage: getPercentage,
      onTouchStart: onTouchStart,
      onTouchMove: onTouchMove,
      onTouchEnd: onTouchEnd,
      onClick: onClick
    };
  }
});

var _hoisted_1 = ["onTouchstart", "onTouchmove", "onTouchend"];
function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_t_node = resolveComponent("t-node");
  return openBlock(), createElementBlock("div", {
    ref: "rootRef",
    class: normalizeClass(_ctx.classes)
  }, [_ctx.showExtremeValue ? (openBlock(), createElementBlock("div", {
    key: 0,
    class: normalizeClass("".concat(_ctx.name, "-wrap__value--left"))
  }, toDisplayString(_ctx.min), 3)) : createCommentVNode("", true), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name)),
    onClick: _cache[0] || (_cache[0] = function () {
      return _ctx.onClick && _ctx.onClick.apply(_ctx, arguments);
    })
  }, [createElementVNode("div", {
    ref: "barRef",
    class: normalizeClass("".concat(_ctx.name, "__bar"))
  }, null, 2), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__track")),
    style: normalizeStyle(_ctx.trackStyle)
  }, null, 6), (openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.dots, function (item, index) {
    return openBlock(), createElementBlock("div", {
      key: index + 1,
      class: normalizeClass(_ctx.handleClass),
      style: normalizeStyle("left:".concat(_ctx.getPercentage(item), "%")),
      onTouchstart: function onTouchstart($event) {
        return _ctx.onTouchStart($event, item);
      },
      onTouchmove: function onTouchmove($event) {
        return _ctx.onTouchMove($event, index);
      },
      onTouchend: function onTouchend($event) {
        return _ctx.onTouchEnd($event, index);
      }
    }, null, 46, _hoisted_1);
  }), 128)), _ctx.marksData ? (openBlock(), createElementBlock("div", {
    key: 0,
    class: normalizeClass("".concat(_ctx.name, "__mark"))
  }, [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.marksData, function (v, k) {
    return openBlock(), createElementBlock("div", {
      key: k,
      class: normalizeClass("".concat(_ctx.name, "__mark-text t-is-").concat(_ctx.value && _ctx.value > v[0] ? "active" : "")),
      style: normalizeStyle("left: ".concat(_ctx.getPercentage(v[0]), "%"))
    }, toDisplayString(typeof v[1] === "function" ? v[1](v[0]) : v[1]), 7);
  }), 128))], 2)) : createCommentVNode("", true)], 2), _ctx.labelContent ? (openBlock(), createElementBlock("div", {
    key: 1,
    class: normalizeClass("".concat(_ctx.name, "-wrap__value"))
  }, [createVNode(_component_t_node, {
    content: _ctx.labelContent
  }, null, 8, ["content"])], 2)) : createCommentVNode("", true), _ctx.showExtremeValue ? (openBlock(), createElementBlock("div", {
    key: 2,
    class: normalizeClass("".concat(_ctx.name, "-wrap__value"))
  }, toDisplayString(_ctx.max), 3)) : createCommentVNode("", true)], 2);
}

script.render = render;

export { script as default };
//# sourceMappingURL=slider.js.map
