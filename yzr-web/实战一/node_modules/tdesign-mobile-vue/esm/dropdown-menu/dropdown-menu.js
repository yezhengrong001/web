/**
 * tdesign v0.12.1
 * (c) 2022 TDesign Group
 * @license MIT
 */

import _defineProperty from '@babel/runtime/helpers/defineProperty';
import { defineComponent, reactive, ref, watch, computed, provide, toRefs, resolveComponent, openBlock, createElementBlock, normalizeClass, createElementVNode, Fragment, renderList, toDisplayString, createVNode, renderSlot } from 'vue';
import { CaretDownSmallIcon } from 'tdesign-icons-vue-next';
import config from '../config.js';
import { context, DropdownMenuExpandState } from './context.js';
import TransAniControl from './trans-ani-control.js';
import { findRelativeRect, findRelativeContainer } from './dom-utils.js';
import DropdownMenuProps from './props.js';
import '@babel/runtime/helpers/classCallCheck';
import '@babel/runtime/helpers/createClass';
import '../shared/functions.js';

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var prefix = config.prefix;
var name = "".concat(prefix, "-dropdown-menu");
var script = defineComponent({
  name: name,
  components: {
    CaretDownSmallIcon: CaretDownSmallIcon
  },
  props: DropdownMenuProps,
  setup: function setup(props, _ref) {
    var slots = _ref.slots,
      expose = _ref.expose;
    var state = reactive({
      activeId: null,
      barRect: {},
      childCount: 0
    });
    var menuItems = ref([]);
    var updateItems = function updateItems() {
      if (slots.default) {
        var itemName = "".concat(prefix, "-dropdown-item");
        var children = slots.default();
        menuItems.value = children.filter(function (child) {
          var _child$type;
          var childTypeName = child === null || child === void 0 ? void 0 : (_child$type = child.type) === null || _child$type === void 0 ? void 0 : _child$type.name;
          return (childTypeName === null || childTypeName === void 0 ? void 0 : childTypeName.includes) && childTypeName.includes(itemName);
        });
      }
    };
    watch(function () {
      var _slots$default;
      return slots === null || slots === void 0 ? void 0 : (_slots$default = slots.default) === null || _slots$default === void 0 ? void 0 : _slots$default.call(slots);
    }, updateItems, {
      deep: true,
      immediate: true
    });
    var menuTitles = computed(function () {
      return menuItems.value.map(function (item) {
        var _item$props = item.props,
          label = _item$props.label,
          disabled = _item$props.disabled;
        return {
          label: label,
          disabled: disabled !== void 0 && disabled !== false
        };
      });
    });
    var aniControl = new TransAniControl();
    provide("dropdownMenuProps", props);
    provide("dropdownMenuState", state);
    provide("dropdownAniControl", aniControl);
    var classes = computed(function () {
      return ["".concat(name)];
    });
    var refBar = ref(null);
    var styleBar = computed(function () {
      return ["".concat(name, "__bar"), _defineProperty({}, "".concat(name, "__bar ").concat(name, "__bar--open"), state.activeId)];
    });
    var styleBarItem = computed(function () {
      return function (item, idx) {
        var _ref3;
        return ["".concat(name, "__item"), (_ref3 = {}, _defineProperty(_ref3, "".concat(prefix, "-is-disabled"), item.disabled), _defineProperty(_ref3, "".concat(prefix, "-is-active"), idx === state.activeId), _ref3)];
      };
    });
    var expandMenu = function expandMenu(item, idx) {
      var disabled = item.disabled;
      if (disabled) return;
      if (state.activeId === idx) {
        collapseMenu();
        return;
      }
      state.activeId = idx;
      var bar = refBar.value;
      var barRect = findRelativeRect(bar);
      state.barRect = barRect;
      var container = findRelativeContainer(bar) || document.body;
      context.recordMenuExpanded(container, control, DropdownMenuExpandState.expanded);
    };
    var collapseMenu = function collapseMenu() {
      state.activeId = null;
      var bar = refBar.value;
      var container = findRelativeContainer(bar) || document.body;
      context.recordMenuExpanded(container, control, DropdownMenuExpandState.collapsed);
    };
    var control = {
      expandMenu: expandMenu,
      collapseMenu: collapseMenu
    };
    provide("dropdownMenuControl", control);
    expose({
      toggle: function toggle(idx) {
        if (idx != null) {
          var item = menuTitles.value[idx];
          expandMenu(item, idx);
        } else {
          collapseMenu();
        }
      }
    });
    return _objectSpread(_objectSpread({
      name: ref(name),
      classes: classes
    }, toRefs(props)), {}, {
      refBar: refBar,
      state: state,
      styleBar: styleBar,
      styleBarItem: styleBarItem,
      menuItems: menuItems,
      menuTitles: menuTitles,
      expandMenu: expandMenu
    });
  }
});

var _hoisted_1 = ["onClick"];
function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_caret_down_small_icon = resolveComponent("caret-down-small-icon");
  return openBlock(), createElementBlock("div", {
    class: normalizeClass(_ctx.classes)
  }, [createElementVNode("div", {
    ref: "refBar",
    class: normalizeClass(_ctx.styleBar)
  }, [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.menuTitles, function (item, idx) {
    return openBlock(), createElementBlock("div", {
      key: idx,
      class: normalizeClass(_ctx.styleBarItem(item, idx)),
      onClick: function onClick($event) {
        return _ctx.expandMenu(item, idx);
      }
    }, [createElementVNode("div", {
      class: normalizeClass("".concat(_ctx.name, "__title"))
    }, toDisplayString(item.label), 3), createVNode(_component_caret_down_small_icon, {
      class: normalizeClass("".concat(_ctx.name, "__arrow")),
      size: "24"
    }, null, 8, ["class"])], 10, _hoisted_1);
  }), 128))], 2), renderSlot(_ctx.$slots, "default")], 2);
}

script.render = render;

export { script as default };
//# sourceMappingURL=dropdown-menu.js.map
