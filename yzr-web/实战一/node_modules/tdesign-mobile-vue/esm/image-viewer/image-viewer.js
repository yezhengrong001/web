/**
 * tdesign v0.12.1
 * (c) 2022 TDesign Group
 * @license MIT
 */

import _defineProperty from '@babel/runtime/helpers/defineProperty';
import _slicedToArray from '@babel/runtime/helpers/slicedToArray';
import { defineComponent, reactive, ref, getCurrentInstance, computed, watch, toRefs, resolveComponent, openBlock, createBlock, normalizeClass, withCtx, createElementBlock, Fragment, createElementVNode, createCommentVNode, createVNode, renderList, normalizeStyle } from 'vue';
import { CloseCircleFilledIcon } from 'tdesign-icons-vue-next';
import config from '../config.js';
import ImageViewerProps from './props.js';
import '../shared/index.js';
import { Swiper, SwiperItem } from '../swiper/index.js';
import Overlay from '../overlay/index.js';
import TNodeComponent from '../shared/render-tnode.js';
import { useEmitEvent } from '../shared/useEmitEvent/index.js';
import { useDefault } from '../shared/useDefault/index.js';
import { useTouch } from '../shared/useTouch/index.js';
import { renderTNode } from '../shared/render.js';
import '../shared/functions.js';
import '../shared/util.js';
import '../shared/component.js';
import '../shared/constants.js';
import '../shared/useToggle/index.js';
import '../shared/useCountDown/index.js';
import '@babel/runtime/helpers/asyncToGenerator';
import '@babel/runtime/regenerator';
import '@vueuse/core';
import '../shared/useCountDown/utils.js';
import '../shared/useChildSlots/index.js';
import '@babel/runtime/helpers/toConsumableArray';
import '../shared/useVModel/index.js';
import '../shared/useScrollParent/index.js';
import '../shared/useExpose/index.js';
import '@babel/runtime/helpers/typeof';
import 'lodash/camelCase';
import '../swiper/swiper.js';
import '../swiper/props.js';
import '../swiper/swiper-item.js';
import '../swiper/style';
import '../swiper/type.js';
import '../overlay/overlay.js';
import '../overlay/props.js';
import '../overlay/style';

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
var prefix = config.prefix;
var name = "".concat(prefix, "-image-viewer");
var getDistance = function getDistance(touches) {
  return Math.sqrt(Math.pow(touches[0].clientX - touches[1].clientX, 2) + Math.pow(touches[0].clientY - touches[1].clientY, 2));
};
var script = defineComponent({
  name: name,
  components: {
    CloseCircleFilledIcon: CloseCircleFilledIcon,
    TSwiper: Swiper,
    TSwiperItem: SwiperItem,
    TOverlay: Overlay,
    TNode: TNodeComponent
  },
  props: ImageViewerProps,
  emits: ["close", "index-change", "update:visible", "update:modelValue", "change"],
  setup: function setup(props, context) {
    var state = reactive({
      zooming: false,
      scale: 1
    });
    var emitEvent = useEmitEvent(props, context.emit);
    var _useDefault = useDefault(props, context.emit, "visible", "change"),
      _useDefault2 = _slicedToArray(_useDefault, 2),
      visible = _useDefault2[0],
      setVisible = _useDefault2[1];
    var lazyVisible = ref(visible.value);
    var touch = useTouch();
    var internalInstance = getCurrentInstance();
    var closeBtnTNode = computed(function () {
      return renderTNode(internalInstance, "closeBtn");
    });
    var navigation = computed(function () {
      if (props.showIndex) {
        return {
          type: "fraction"
        };
      }
      return {
        type: "dots",
        showSlideBtn: false
      };
    });
    var imageStyle = computed(function () {
      var scale = state.scale,
        zooming = state.zooming;
      var style = {
        transitionDuration: zooming ? "0s" : ".3s"
      };
      if (scale !== 1) {
        style.transform = "scale(".concat(scale, ", ").concat(scale, ")");
      }
      return style;
    });
    var handleClose = function handleClose(e, trigger) {
      setVisible(false);
      emitEvent("close", {
        trigger: trigger,
        e: e
      });
    };
    var onSwiperChange = function onSwiperChange(index, context2) {
      emitEvent("index-change", index);
    };
    var fingerNum;
    var startScale;
    var startDistance;
    var doubleTapTimer;
    var touchStartTime;
    var onTouchStart = function onTouchStart(event) {
      event.preventDefault();
      event.stopPropagation();
      var touches = event.touches;
      touch.start(event);
      fingerNum = touches.length;
      touchStartTime = Date.now();
      state.zooming = fingerNum === 2;
      if (state.zooming) {
        startScale = state.scale;
        startDistance = getDistance(event.touches);
      }
    };
    var onTouchMove = function onTouchMove(event) {
      var touches = event.touches;
      touch.move(event);
      event.preventDefault();
      event.stopPropagation();
      if (state.zooming) {
        event.preventDefault();
        event.stopPropagation();
      }
      if (state.zooming && touches.length === 2) {
        var distance = getDistance(touches);
        var scale = startScale * distance / startDistance;
        setScale(scale);
      }
    };
    var setScale = function setScale(scale) {
      scale = Math.min(scale, +props.maxZoom + 1);
      if (scale !== state.scale) {
        state.scale = scale;
      }
    };
    var resetScale = function resetScale() {
      setScale(1);
    };
    var toggleScale = function toggleScale() {
      var scale = state.scale > 1 ? 1 : 2;
      setScale(scale);
    };
    var checkTap = function checkTap(event) {
      if (fingerNum > 1) {
        return;
      }
      var offsetX = touch.offsetX,
        offsetY = touch.offsetY;
      var deltaTime = Date.now() - touchStartTime;
      var TAP_TIME = 250;
      var TAP_OFFSET = 5;
      if (offsetX.value < TAP_OFFSET && offsetY.value < TAP_OFFSET && deltaTime < TAP_TIME) {
        if (doubleTapTimer) {
          clearTimeout(doubleTapTimer);
          doubleTapTimer = null;
          toggleScale();
        } else {
          doubleTapTimer = window.setTimeout(function () {
            handleClose(event, "overlay");
            doubleTapTimer = null;
          }, TAP_TIME);
        }
      }
    };
    var onTouchEnd = function onTouchEnd(event) {
      event.preventDefault();
      if (state.zooming) {
        event.stopPropagation();
        if (!event.touches.length) {
          if (state.zooming) {
            state.zooming = false;
          }
          startScale = 1;
          if (state.scale < 1) {
            resetScale();
          }
          if (state.scale > props.maxZoom) {
            state.scale = +props.maxZoom;
          }
        }
      }
      checkTap(event);
      touch.reset();
    };
    watch(function () {
      return visible.value;
    }, function (value) {
      if (!value) {
        resetScale();
      }
      setTimeout(function () {
        lazyVisible.value = value;
      }, 300);
    });
    return _objectSpread(_objectSpread({
      name: name,
      prefix: prefix,
      closeBtnTNode: closeBtnTNode,
      navigation: navigation,
      imageStyle: imageStyle,
      lazyVisible: lazyVisible
    }, toRefs(props)), {}, {
      visible: visible,
      handleClose: handleClose,
      onSwiperChange: onSwiperChange,
      onTouchStart: onTouchStart,
      onTouchMove: onTouchMove,
      onTouchEnd: onTouchEnd
    });
  }
});

var _hoisted_1 = ["src"];
function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_t_node = resolveComponent("t-node");
  var _component_close_circle_filled_icon = resolveComponent("close-circle-filled-icon");
  var _component_t_swiper_item = resolveComponent("t-swiper-item");
  var _component_t_swiper = resolveComponent("t-swiper");
  var _component_t_overlay = resolveComponent("t-overlay");
  return openBlock(), createBlock(_component_t_overlay, {
    class: normalizeClass("".concat(_ctx.prefix, "-image-viewer")),
    visible: _ctx.visible
  }, {
    default: withCtx(function () {
      return [_ctx.lazyVisible ? (openBlock(), createElementBlock(Fragment, {
        key: 0
      }, [createElementVNode("div", {
        class: normalizeClass("".concat(_ctx.name, "__close-icon")),
        onClick: _cache[0] || (_cache[0] = function ($event) {
          return _ctx.handleClose($event, "close-btn");
        })
      }, [!(typeof _ctx.closeBtnTNode === "boolean") ? (openBlock(), createBlock(_component_t_node, {
        key: 0,
        content: _ctx.closeBtnTNode
      }, null, 8, ["content"])) : typeof _ctx.closeBtn === "boolean" && _ctx.closeBtn ? (openBlock(), createBlock(_component_close_circle_filled_icon, {
        key: 1
      })) : createCommentVNode("", true)], 2), createVNode(_component_t_swiper, {
        autoplay: false,
        class: normalizeClass("".concat(_ctx.name, "__swipe")),
        "default-current": _ctx.initialIndex,
        navigation: _ctx.navigation,
        "on-change": _ctx.onSwiperChange
      }, {
        default: withCtx(function () {
          return [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.images, function (image, index) {
            return openBlock(), createBlock(_component_t_swiper_item, {
              key: image + index,
              class: normalizeClass("".concat(_ctx.name, "__swipe-item")),
              onTouchstart: _ctx.onTouchStart,
              onTouchmove: _ctx.onTouchMove,
              onTouchend: _ctx.onTouchEnd
            }, {
              default: withCtx(function () {
                return [createElementVNode("img", {
                  src: image,
                  style: normalizeStyle(_ctx.imageStyle),
                  class: normalizeClass("".concat(_ctx.name, "__image"))
                }, null, 14, _hoisted_1)];
              }),
              _: 2
            }, 1032, ["class", "onTouchstart", "onTouchmove", "onTouchend"]);
          }), 128))];
        }),
        _: 1
      }, 8, ["class", "default-current", "navigation", "on-change"])], 64)) : createCommentVNode("", true)];
    }),
    _: 1
  }, 8, ["class", "visible"]);
}

script.render = render;

export { script as default };
//# sourceMappingURL=image-viewer.js.map
