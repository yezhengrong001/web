/**
 * tdesign v0.12.1
 * (c) 2022 TDesign Group
 * @license MIT
 */

import _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';
import _slicedToArray from '@babel/runtime/helpers/slicedToArray';
import { defineComponent, toRefs, computed, ref, onMounted, nextTick, resolveComponent, openBlock, createElementBlock, normalizeClass, createElementVNode, createVNode, withCtx, createTextVNode, toDisplayString, Fragment, renderList, createBlock } from 'vue';
import config from '../config.js';
import PickerProps from './props.js';
import _Button from '../button/index.js';
import '../shared/index.js';
import script$1 from './picker-item.js';
import { useEmitEvent } from '../shared/useEmitEvent/index.js';
import { useVModel } from '../shared/useVModel/index.js';
import { useChildSlots } from '../shared/useChildSlots/index.js';
import { useExpose } from '../shared/useExpose/index.js';
import '../button/button.js';
import '@babel/runtime/helpers/defineProperty';
import 'tdesign-icons-vue-next';
import '../shared/constants.js';
import '../button/props.js';
import '../shared/render-tnode.js';
import '../shared/render.js';
import '@babel/runtime/helpers/typeof';
import 'lodash/camelCase';
import '../shared/functions.js';
import '../shared/util.js';
import '../shared/component.js';
import '../shared/useToggle/index.js';
import '../shared/useCountDown/index.js';
import '@babel/runtime/helpers/asyncToGenerator';
import '@babel/runtime/regenerator';
import '@vueuse/core';
import '../shared/useCountDown/utils.js';
import '../shared/useDefault/index.js';
import '../shared/useTouch/index.js';
import '../shared/useScrollParent/index.js';
import './style/css.js';
import '../button/type.js';
import './picker.class.js';
import '@babel/runtime/helpers/classCallCheck';
import '@babel/runtime/helpers/createClass';

var prefix = config.prefix;
var name = "".concat(prefix, "-picker");
var getIndexFromColumns = function getIndexFromColumns(columns, value, column) {
  var _columns$column;
  var resultIndex;
  (_columns$column = columns[column]) === null || _columns$column === void 0 ? void 0 : _columns$column.forEach(function (item, index) {
    if (item.value === value) {
      resultIndex = index;
    }
  });
  return resultIndex;
};
var script = defineComponent({
  name: name,
  components: {
    TButton: _Button,
    PickerItem: script$1
  },
  props: PickerProps,
  emits: ["change", "cancel", "pick", "update:modelValue", "update:value"],
  setup: function setup(props, context) {
    var emitEvent = useEmitEvent(props, context.emit);
    var _toRefs = toRefs(props),
      value = _toRefs.value,
      modelValue = _toRefs.modelValue;
    var _useVModel = useVModel(value, modelValue, props.defaultValue, props.onChange),
      _useVModel2 = _slicedToArray(_useVModel, 2),
      pickerValue = _useVModel2[0],
      setPickerValue = _useVModel2[1];
    var confirmButtonText = computed(function () {
      return props.confirmBtn;
    });
    var cancelButtonText = computed(function () {
      return props.cancelBtn;
    });
    var curValueArray = ref(pickerValue.value.map(function (item) {
      return item;
    }));
    var realColumns = computed(function () {
      if (typeof props.columns === "function") {
        var data = props.columns(curValueArray.value);
        return data;
      }
      return props.columns;
    });
    var lastTimeValueArray = _toConsumableArray(curValueArray.value);
    var curIndexArray = pickerValue.value.map(function (item, index) {
      return getIndexFromColumns(realColumns.value, item, index);
    });
    var lastTimeIndexArray = _toConsumableArray(curIndexArray);
    var pickerItemInstanceArray = ref([]);
    onMounted(function () {
      pickerItemInstanceArray.value = useChildSlots("t-picker-item").map(function (item) {
        return item.component;
      });
    });
    var handleConfirm = function handleConfirm(e) {
      lastTimeValueArray = _toConsumableArray(curValueArray.value);
      lastTimeIndexArray = _toConsumableArray(curIndexArray);
      setPickerValue(curValueArray.value);
      emitEvent("confirm", curValueArray.value, {
        index: curIndexArray
      });
    };
    var handleCancel = function handleCancel(e) {
      curValueArray.value = _toConsumableArray(lastTimeValueArray);
      curIndexArray = _toConsumableArray(lastTimeIndexArray);
      pickerItemInstanceArray.value.forEach(function (item, index) {
        var _item$exposed;
        (_item$exposed = item.exposed) === null || _item$exposed === void 0 ? void 0 : _item$exposed.setIndex(curIndexArray[index]);
      });
      emitEvent("cancel", {
        e: e
      });
    };
    var handlePick = function handlePick(context2, column) {
      if (curValueArray.value[column] !== context2.value) {
        curValueArray.value[column] = context2.value;
        curIndexArray[column] = context2.index;
        if (typeof props.columns === "function") {
          var result = props.columns(curValueArray.value);
          result.forEach(function (item, index) {
            if (!item.filter(function (ele) {
              return ele.value === curValueArray.value[index];
            }).length) {
              var _item$;
              curValueArray.value[index] = (_item$ = item[0]) === null || _item$ === void 0 ? void 0 : _item$.value;
              curIndexArray[index] = 0;
              nextTick(function () {
                var _pickerItemInstanceAr, _pickerItemInstanceAr2;
                (_pickerItemInstanceAr = pickerItemInstanceArray.value[index]) === null || _pickerItemInstanceAr === void 0 ? void 0 : (_pickerItemInstanceAr2 = _pickerItemInstanceAr.exposed) === null || _pickerItemInstanceAr2 === void 0 ? void 0 : _pickerItemInstanceAr2.setIndex(0);
              });
            } else {
              nextTick(function () {
                var _pickerItemInstanceAr3, _pickerItemInstanceAr4;
                (_pickerItemInstanceAr3 = pickerItemInstanceArray.value[index]) === null || _pickerItemInstanceAr3 === void 0 ? void 0 : (_pickerItemInstanceAr4 = _pickerItemInstanceAr3.exposed) === null || _pickerItemInstanceAr4 === void 0 ? void 0 : _pickerItemInstanceAr4.setUpdateItems();
              });
            }
          });
        }
        emitEvent("pick", curValueArray.value, {
          index: context2.index,
          column: column
        });
      }
    };
    var setValues = function setValues(values) {
      curValueArray.value = values;
      setPickerValue(values);
      nextTick(function () {
        pickerItemInstanceArray.value.forEach(function (item, index) {
          var _item$exposed2;
          (_item$exposed2 = item.exposed) === null || _item$exposed2 === void 0 ? void 0 : _item$exposed2.setValue(values[index]);
        });
      });
    };
    useExpose({
      setValues: setValues
    });
    return {
      name: name,
      pickerValue: pickerValue,
      confirmButtonText: confirmButtonText,
      cancelButtonText: cancelButtonText,
      handleConfirm: handleConfirm,
      handleCancel: handleCancel,
      handlePick: handlePick,
      realColumns: realColumns
    };
  }
});

function render(_ctx, _cache, $props, $setup, $data, $options) {
  var _component_t_button = resolveComponent("t-button");
  var _component_picker_item = resolveComponent("picker-item");
  return openBlock(), createElementBlock("div", {
    class: normalizeClass("".concat(_ctx.name))
  }, [createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__toolbar"))
  }, [createVNode(_component_t_button, {
    class: normalizeClass("".concat(_ctx.name, "__cancel")),
    variant: "text",
    onClick: _ctx.handleCancel
  }, {
    default: withCtx(function () {
      return [createTextVNode(toDisplayString(_ctx.cancelButtonText), 1)];
    }),
    _: 1
  }, 8, ["class", "onClick"]), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__title"))
  }, toDisplayString(_ctx.title), 3), createVNode(_component_t_button, {
    class: normalizeClass("".concat(_ctx.name, "__confirm")),
    variant: "text",
    onClick: _ctx.handleConfirm
  }, {
    default: withCtx(function () {
      return [createTextVNode(toDisplayString(_ctx.confirmButtonText), 1)];
    }),
    _: 1
  }, 8, ["class", "onClick"])], 2), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__main"))
  }, [createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "-item__group"))
  }, [(openBlock(true), createElementBlock(Fragment, null, renderList(_ctx.realColumns, function (item, index) {
    return openBlock(), createBlock(_component_picker_item, {
      key: index,
      options: item,
      "default-value": _ctx.pickerValue[index],
      "render-label": _ctx.renderLabel,
      onPick: function onPick($event) {
        return _ctx.handlePick($event, index);
      }
    }, null, 8, ["options", "default-value", "render-label", "onPick"]);
  }), 128))], 2), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__mask"))
  }, null, 2), createElementVNode("div", {
    class: normalizeClass("".concat(_ctx.name, "__indicator"))
  }, null, 2)], 2)], 2);
}

script.render = render;

export { script as default };
//# sourceMappingURL=picker.js.map
